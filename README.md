# Nebo

Say hello to Nebo (Nebulous Cloud Being)

<img style="border-radius: 20px; box-shadow: 3px 3px 5px 0px rgba(173,154,173,1);" src="https://www.gravatar.com/avatar/1abed234f87b8153b2cda61601fbb1f9.jpg">

Nebo is a being of many talents. Abilities/roles include:
- Slackbot. Nebo helps find data on our customers without needing to go to the database.
- NPS Bot. Nebo sends NPS ratings and feedback from the SMC to the #nps slack channel.
- Supplies a list of all our customers siteID's and Domain Names for the [SiteIDToDomainName](https://chrome.google.com/webstore/detail/siteid-to-domain/ggmcjkngfgckplleegapeifknomknkeh?hl=en) Chrome Extension
- Listens for new channels to be created to share in a new channels channel in slack

## Usage - Base URL https://salesforce-bot.vercel.app/

## Slack Commands üíª
- `/nebo shoes.com`
- `/nebo bigcommerce`
- `/neboidnx A21BCDE5FE33` - find a customer with this key in the Nextopia system
- `/neboidss m6umjp` - find a customer with this ID in the Searchspring system
- `/feature i want this feature please`
- `/fire` - fire checklist
- `/firedown` - fire over checklist
- `/meet` - generate a randomly named meeting invite

## NPS Endpoint üìã

#### Endpoint starts at `/nps` with 3 manditory fields
- `name` (string)
- `email` (string)
- `website` (string)

#### and 2 interchangable fields
*If both fields are used in the same request, the feedback will be overwritten by the rating so only use ONE at a time* 
- `rating` (int)
- `feedback` (string)


### Examples
1. This would be an example to post a message with a rating `/nps?name=clientName&email=clientEmail&website=clientWebsite&rating=clientRating`
2. This would be an example to post a message with feedback `/nps?name=clientName&email=clientEmail&website=clientWebsite&feedback=clientFeedback`

## ListSites Endpoint üìù

#### Endpoint is `/listSites` with no fields
- Request: All requests to this endpoint require an authorization header with a [GoogleOAuth Token](https://developers.google.com/identity/protocols/oauth2) attached
- Response: After the auth token is verifed, nebo will send back an array of objects that look like `{Website: "test.com", SiteID: "abc123"}

## New Channel Listener üëÇ

#### Nebo is always listening for new channels and will post a link to them in the [#new-channels](https://searchspring.slack.com/archives/C01VD4Z343B) channel.

# Development

### Prerequisites
- Install Go https://golang.org/doc/install
- Install Node https://nodejs.org/en/download/
- Install vercel `npm install -g vercel`
- Install ngrok `npm install -g ngrok` (because we were too lazy to mock things)

### Signing into the Vercel CLI and setting up your project **(Only First Time Setup)**

1. ```vercel login```
2. Enter email: "machine@searchspring.com"
3. Go to https://groups.google.com/a/searchspring.com/g/machine and click the link in the confirmation email, then return to terminal
4. Run ```vercel dev``` and you will be prompted with _Setup and develop (root folder)? (Y/n)_ choose Y
5. You will then be asked to choose a _scope_. Choose _machine_
6. It should then prompt _Found machine/(project_name) Link to it? (Y/n)_ Choose Y and you should be running now on http://localhost:3000  

### Run locally
1. Download `nebo.env` from SSEng in 1password 
2. Create a .env file for local development
    ```properties
    SF_URL=https://<your url>.my.salesforce.com
    SF_USER=<sf login email>
    SF_PASSWORD=<sf password>
    SF_TOKEN=<sf token>
    METABASE_USER=<metabase login email>
    METABASE_PASSWORD=<metabase password>
    SLACK_VERIFICATION_TOKEN=<slack token>
    SLACK_OAUTH_TOKEN=<slack oauth token>
    NX_USER=<nx user>
    NX_PASSWORD=<nx password>
    GDRIVE_FIRE_DOC_FOLDER_ID=<gdrive folder id>
    DEV_MODE=<production | development>
    ```
    * If `DEV_MODE` is set to `development` you will be able to test various commands without requiring _all_ env vars to be set to non-blank values
3. Run the server `vercel dev`
4. Run ngrok `ngrok http 3000`
5. Modify your slash command in slack [here](https://api.slack.com/apps/AV2R6PWUS/slash-commands) to point at the URL generated by ngrok in the step above
    * You may need to ask [#engineering](https://searchspring.slack.com/archives/CS8DR87V1) for access

## Tests
Run tests with
```sh
go test ./...
```

## Production
1. Login to vercel
    ```sh
    vercel login machine@searchspring.com
    # It'll send an email to you if you have access
    # You may need to slack #engineering for someone with access to fwd it to you
    ```
2. Ensure all needed secrets exist
    ```sh
    # List secrets
    vercel secrets list
    # Add
    vercel secret add <name> <value>
    # Remove
    vercel secret rm <name> <value>
    ```
    * Vercel requires secrets are set using all lower kabob case so `THIS_EXAMPLE` becomes `this-example`

3. Make sure you've checked out Master and have pulled all the changes you want to deploy.
4. Run `vercel` to deploy to staging and test the application before deploying it to production.
5. Deploy using `vercel --prod`

## Help/Issues/Feature Requests üôã
If you need help with the api, have questions, or an idea for a new feature, please either: 
- Add an issue [HERE](https://github.com/searchspring/nebo/issues/new)  
- Post a message in [Development Nebo](https://searchspring.slack.com/archives/C01N8NERZ7S)

and we will get back to you as soon as possible üòÄ
